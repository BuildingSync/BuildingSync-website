{% extends 'bsviewer/base.html' %}

{% load bootstrap3 %}
{% load staticfiles %}

{% block extra_head %}
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.5/themes/default/style.min.css"/>
{% endblock %}

{% block title %}BuildingSync Schema Viewer - Data Dictionary{% endblock %}

{% block content_notitle %}

  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div class="dropdown pull-right header-row-item">
          <button class="btn btn-default btn-sm dropdown-toggle" type="button" id="versionSelector"
                  data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Version: {{ schema_version }} <span class="caret"></span>
          </button>
          <ul class="dropdown-menu" aria-labeledby="versionSelector">
            {% for version in versions %}
              <li>
                <a href="{{ version.link }}">
                  {{ version.name }}
                  {% if version.is_current %}
                    <span class="glyphicon glyphicon-ok" aria-hidden="false"></span>
                    <span class="sr-only"> selected</span>
                  {% endif %}
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>
         <header class="major">
          <h2>Data Dictionary</h2>
        </header>
      </div>
    </div>

    <div class="row">
      <div class="col-md-8">
        <div class="panel panel-accent">
          <div class="panel-heading">
            <h3 class="panel-title">Schema Browser</h3>
          </div>
          <div class="panel-body" id="schematree"></div>
        </div>
      </div>
      <div class="col-md-4">


        <h4>Search</h4>
        <form class="form-inline" role="form" id="treesearch">
          <div class="form-group">
            <label class="sr-only">Search</label>
            <input type="text" class="form-control" id="treesearchquery">
          </div>
          <button type="submit" class="btn btn-default" style="margin-bottom:20px;"><span
              class="glyphicon glyphicon-search"></span></button>
        </form>

        <h2 id="enum_title" class="hidden">SELECTED NAME</h2>
        <!--TODO: eventually look up the bedes term and display here-->
        <div class="panel panel-default">
            <div class="panel-heading">
                <h2 class="panel-title">Data Dictionary Links</h2>
            </div>
            <div class="panel-body">
               <p><span class="badge badge-accent2"> &nbsp;Coming Soon &nbsp; </span></p>
            </div>
         </div>

         <div id="enum_panel" class="panel panel-default hidden">
            <div class="panel-heading">
                <h2 class="panel-title">Enumerations</h2>
            </div>
            <div class="panel-body">
               <div id="enum_results"></div>
            </div>
         </div>

      </div>
    </div>

  </div>

{% endblock content_notitle %}

{% block extra_script %}
  <script src="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.5/jstree.min.js"></script>
  <script type="application/javascript">
      $(function () {
          let data = {{ schema_tree_data|safe }};

          $('#schematree').jstree({
              'core': {
                  'data': data,
                  'multiple': false
              },
              'plugins': ["search", "contextmenu"],
             /* 'contextmenu': {
                  'items': function (node, callback) {
                      if (node.data !== null) {
                          callback({
                              'gotoid': {
                                  'label': 'Go to ' + node.data['refid'],
                                  'action': function () {
                                      var jst = $('#schematree').jstree(true);
                                      jst.deselect_node(node);
                                      jst.select_node(jst.get_node(node.data['refid']));
                                  },
                                  'icon': 'glyphicon glyphicon-share-alt'
                              }
                          });
                      }
                  }
              } */
          }).on('changed.jstree', function (e, data) {
            // display enums when present
            if (data.action === 'select_node' && data.selected.length > 0){
              var node = data.instance.get_node(data.selected[0]);
              // retrieve and display enum (if present)
              $.ajax({
                url: '{% url "bsviewer:get_enum" %}',
                data: {
                  'element_id': data.selected[0]
                },
                dataType: 'json',
                success: function (jsondata) {
                  if (jsondata.has_enum) {
                    // TODO: set enum html section and display
                    $('#enum_title').removeClass("hidden").addClass("visible");
                    $('#enum_title').html(node.text);
                    $('#enum_panel').removeClass("hidden").addClass("visible");
                    $('#enum_results').html('');
                    /*$('#enum_results').html(jsondata.enums );*/
                      var ul = $('<ul>').appendTo('#enum_results');
                      $(jsondata.enums).each(function(index, item) {
                          console.log(item);
                        ul.append(
                            $(document.createElement('li')).text(item)
                        );
                      });

                  } else {
                    $('#enum_panel').addClass("hidden");
                  }
                }
              });
            } else {
              $('#enum_panel').addClass("hidden");
            }
          });

      });
      $("#treesearch").submit(function (e) {
          e.preventDefault();
          $('#schematree').jstree(true).search($("#treesearchquery").val());
      });
  </script>

{% endblock extra_script %}